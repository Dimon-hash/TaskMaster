<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Тренировка — камера</title>
  <style>
    :root{color-scheme:dark}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b0f14;color:#fff;user-select:none;touch-action:none}
    .wrap{padding:16px;display:flex;flex-direction:column;gap:14px;align-items:center;max-width:520px;margin:0 auto}
    video#v{width:100%;max-width:480px;border-radius:16px;background:#000}
    canvas#c{display:none}
    .title{font-size:16px;opacity:.95;text-align:center}
    .pill{font-variant-numeric:tabular-nums;font-weight:700;background:#0f1620;border:1px solid #1d2732;border-radius:999px;padding:8px 12px}
    .status{font-size:14px;opacity:.85;text-align:center}
    .err{color:#ff6b6b}
    .muted{opacity:.8}
    .btn{appearance:none;border:1px solid #1d2732;background:#0f1620;color:#fff;border-radius:10px;padding:10px 14px;font-size:14px}
    .btn:active{transform:scale(0.99)}
    #shield{position:fixed;inset:0;background:rgba(11,15,20,.6);backdrop-filter:saturate(120%) blur(2px);display:none;align-items:center;justify-content:center;z-index:9999;pointer-events:auto;cursor:wait}
    #shield.active{display:flex}
    #shield .msg{font-size:15px;opacity:.95;padding:12px 14px;background:#0f1620;border:1px solid #1d2732;border-radius:12px}
    .noclick{pointer-events:none}
    #closeBtn{display:none;margin-top:8px}
    #closeBtn.show{display:inline-block}
  </style>
</head>
<body>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<div class="wrap">
  <div class="title">Камера готовится…</div>
  <video id="v" playsinline autoplay muted></video>
  <canvas id="c"></canvas>

  <div class="pill">Снимки выполняются: 1 — случайно, 2 и 3 — через отдых</div>
  <div class="status muted">Не закрывай это окно до конца тренировки.</div>

  <button id="closeBtn" class="btn">Закрыть</button>
</div>

<div id="shield"><div class="msg">Тренировка идёт… не закрывай окно</div></div>

<script>
(() => {
  const tg = window.Telegram?.WebApp;
  tg?.expand?.(); tg?.ready?.();

  let stream = null, wakeLock = null, keepAliveTimer = null;
  let canClose = false;

  const v = document.getElementById('v');
  const c = document.getElementById('c');
  const title = document.querySelector('.title');
  const pill  = document.querySelector('.pill');
  const status= document.querySelector('.status');
  const shield= document.getElementById('shield');
  const closeBtn = document.getElementById('closeBtn');

  const qs = new URLSearchParams(location.search);
  const totalSec  = Math.max(60, parseInt(qs.get('window') || '3600', 10));  // вся длительность тренировки
  const restSec   = Math.max(1,  parseInt(qs.get('rest')   || '60',   10));  // отдых между 2-м и 3-м кадром
  const inTelegram = !!(tg && (tg.platform || tg.initDataUnsafe?.user || (tg.initData && tg.initData.length)));
  const dev = qs.get('dev') === '1' || !inTelegram;

  // ---------- утилиты ----------
  function setStatus(text, isErr=false){
    status.textContent = text;
    status.className = 'status' + (isErr ? ' err' : ' muted');
  }
  function stopStream(){ try{ stream?.getTracks?.().forEach(t=>t.stop()); }catch(_){} stream=null; }
  const sleep = ms => new Promise(r=>setTimeout(r, ms));

  function canvasToBlob(canvas, type='image/jpeg', q=0.9){
    return new Promise(res=>{
      if (canvas.toBlob) return canvas.toBlob(b=>res(b), type, q);
      const dataURL = canvas.toDataURL(type, q);
      const bin = atob(dataURL.split(',')[1]);
      const bytes = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
      res(new Blob([bytes], {type}));
    });
  }

  async function captureAndUploadToken(){
    const vw=v.videoWidth||720, vh=v.videoHeight||1280;
    const w=Math.min(1280,vw), h=Math.round(w*(vh/vw));
    c.width=w; c.height=h;
    const ctx = c.getContext('2d', {willReadFrequently:true});
    ctx.drawImage(v,0,0,w,h);

    const blob = await canvasToBlob(c,'image/jpeg',0.9);
    const form = new FormData();
    form.append('photo', blob, `shot_${Date.now()}.jpg`);
    form.append('initData', inTelegram ? (tg.initData || '') : '');

    const uploadUrl = new URL('/upload' + (dev ? '?dev=1' : ''), location.origin).toString();
    const r = await fetch(uploadUrl, { method:'POST', body:form });
    if (!r.ok){
      const t = await r.text().catch(()=>String(r.status));
      throw new Error(`Upload failed: ${r.status} ${t}`);
    }
    const data = await r.json();
    if (!data?.token) throw new Error('No token from server');
    return String(data.token);
  }

  async function ensureCamera(){
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'user' } }, audio:false });
    } catch {
      stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    }
    v.srcObject = stream;
    await new Promise(res=>{
      if (v.readyState >= 1) return res();
      v.addEventListener('loadedmetadata', res, {once:true});
    });
    try { await v.play(); } catch {}
  }

  // Wake Lock + keep-alive
  async function requestWakeLock(){
    try{
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
        document.addEventListener('visibilitychange', async () => {
          if (document.visibilityState === 'visible') {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch {}
          }
        });
      }
    }catch(e){}
  }
  function startKeepAlive(){
    clearInterval(keepAliveTimer);
    keepAliveTimer = setInterval(() => {
      v.play?.().catch(()=>{});
      tg?.expand?.();
    }, 30000);
  }
  function stopKeepAlive(){ clearInterval(keepAliveTimer); keepAliveTimer=null; }

  // блок закрытия
  function lockUI(){
    shield.classList.add('active');
    document.body.classList.add('noclick');
    tg?.enableClosingConfirmation?.();
  }
  function unlockClicksOnly(){
    shield.classList.remove('active');
    document.body.classList.remove('noclick');
    // confirmation оставляем включенным до явного «Закрыть»
  }

  // кнопка Закрыть
  function showCloseControls(){
    try{
      tg?.MainButton?.setParams?.({text:'Закрыть', is_visible:true});
      tg?.MainButton?.show?.();
      tg?.onEvent?.('mainButtonClicked', () => { canClose = true; tg?.close?.(); });
    }catch(_){}
    closeBtn.classList.add('show');
    closeBtn.onclick = () => {
      canClose = true;
      window.close();
      setTimeout(() => alert('Можно закрыть вкладку/вернуться назад.'), 100);
    };
  }

  // вычислим моменты трёх снимков:
  function planShots(totalSec, restSec){
    const totalMs = totalSec*1000, restMs = restSec*1000;
    const minFirst = Math.max(restMs, 5000);
    const latestFirst = Math.max(minFirst, totalMs - 2*restMs - 3000);
    const firstDelay = Math.floor(minFirst + Math.random() * Math.max(1, (latestFirst - minFirst)));
    const t1 = firstDelay;
    const t2 = t1 + restMs;
    const t3 = t2 + restMs;
    return [t1, t2, t3];
  }

  async function runWorkout(){
    title.textContent = 'Режим тренировки';
    pill.textContent  = `Окно: ${Math.round(totalSec/60)} мин • отдых: ${restSec} сек`;
    setStatus('Камера активна. Не закрывай это окно.');

    lockUI();
    await requestWakeLock();
    startKeepAlive();
    try { await document.documentElement.requestFullscreen?.(); } catch {}
    try { await screen.orientation?.lock?.('portrait'); } catch {}

    await ensureCamera();

    const start = Date.now();
    const [t1, t2, t3] = planShots(totalSec, restSec);
    const tokens = [];

    // ждём до первого случайного момента
    await sleep(Math.max(0, t1 - (Date.now() - start)));
    try { tokens.push(await captureAndUploadToken()); setStatus('Снимок 1/3 выполнен…'); } catch(e){ setStatus('Ошибка на снимке 1: '+(e?.message||e), true); }

    // снимок 2 через rest
    await sleep(Math.max(0, t2 - (Date.now() - start)));
    try { tokens.push(await captureAndUploadToken()); setStatus('Снимок 2/3 выполнен…'); } catch(e){ setStatus('Ошибка на снимке 2: '+(e?.message||e), true); }

    // снимок 3 через rest
    await sleep(Math.max(0, t3 - (Date.now() - start)));
    try { tokens.push(await captureAndUploadToken()); setStatus('Снимок 3/3 выполнен…'); } catch(e){ setStatus('Ошибка на снимке 3: '+(e?.message||e), true); }

    // ждём до конца окна
    const endAt = start + totalSec*1000;
    const remain = endAt - Date.now();
    if (remain > 0) {
      setStatus('Дождись окончания окна тренировки…');
      await sleep(remain);
    }

    // отправляем результат одним пакетом
    try{
      if (inTelegram) {
        tg.sendData(JSON.stringify({ type:'workout_set', tokens }));
      } else {
        console.log('DEV tokens:', tokens);
      }
    }catch(e){ console.error(e); }

    pill.textContent = 'Сеанс завершён';
    setStatus('Готово. Нажми «Закрыть», чтобы выйти.');

    unlockClicksOnly();
    stopStream(); stopKeepAlive();
    try { await screen.orientation?.unlock?.(); } catch {}

    showCloseControls();
  }

  async function run(){
    try{
      await runWorkout();
    }catch(e){
      console.error(e);
      setStatus('Ошибка камеры/загрузки: ' + (e?.message||e), true);
      stopStream(); stopKeepAlive();
    }
  }

  window.addEventListener('beforeunload', (e) => {
    if (!canClose) { e.preventDefault(); e.returnValue = ''; }
  });

  tg?.onEvent?.('viewportChanged', () => tg?.expand?.());
  window.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') v.play?.().catch(()=>{});
  });

  run();
})();
</script>
</body>
</html>
