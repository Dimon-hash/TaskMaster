<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сделать фото</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b0f14;color:#fff}
    .wrap{padding:16px;display:flex;flex-direction:column;gap:12px;align-items:center}
    video,canvas{width:100%;max-width:480px;border-radius:16px}
    .count{font-size:28px;font-weight:700;margin:8px}
    .btn{padding:12px 16px;border:0;border-radius:12px;font-size:16px;background:#1f6feb;color:#fff}
    .muted{opacity:.8;font-size:14px}
    .err{color:#ff6b6b}
  </style>
</head>
<body>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<div class="wrap">
  <div class="muted">Камера запустится автоматически. Первый раз ОС спросит разрешение.</div>
  <video id="v" playsinline autoplay muted></video>
  <div id="count" class="count"></div>
  <button id="cancel" class="btn">Отмена</button>
  <div id="msg" class="muted"></div>
  <canvas id="c" style="display:none"></canvas>
</div>
<script>
const tg = window.Telegram.WebApp; tg.expand();
let canceled = false;
const v = document.getElementById('v');
const c = document.getElementById('c');
const count = document.getElementById('count');
const msg = document.getElementById('msg');

document.getElementById('cancel').onclick = () => { canceled = true; tg.close(); };

(async () => {
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
    v.srcObject = stream;

    // ждём метаданные видеопотока
    await new Promise(res => v.onloadedmetadata ? res() : v.addEventListener('loadedmetadata', res, {once:true}));

    // обратный отсчёт 3..2..1
    for(let n=3;n>0;n--){ if(canceled) return; count.textContent = n; await new Promise(r=>setTimeout(r,1000)); }
    count.textContent = '';
    if(canceled) return;

    // снимок
    const w = Math.min(1280, v.videoWidth || 720);
    const h = Math.round(w * (v.videoHeight/(v.videoWidth||1)));
    c.width = w; c.height = h; c.getContext('2d').drawImage(v,0,0,w,h);
    const blob = await new Promise(res => c.toBlob(res, 'image/jpeg', 0.85));

    // загрузка на сервер -> получаем token
    const form = new FormData();
    form.append('photo', blob, 'auto.jpg');
    form.append('initData', tg.initData);
    const r = await fetch('/upload', { method:'POST', body:form, credentials:'include' });
    if(!r.ok) throw new Error(await r.text());
    const data = await r.json();

    // отправляем токен в бота
    tg.sendData(JSON.stringify({ type:'photo_uploaded', token:data.token, auto:true }));
    tg.close();
  }catch(e){
    msg.className='err'; msg.textContent='Ошибка камеры: '+e.message;
  }
})();
</script>
</body>
</html>