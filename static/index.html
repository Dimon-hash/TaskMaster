<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Тренировка — камера</title>
  <style>
    :root{color-scheme:dark}
    html,body{min-height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:#0b0f14;color:#fff;
      user-select:none;              /* оставляем запрет выделения */
      /* touch-action:none; */       /* УБРАНО — скролл снова работает */
      -webkit-overflow-scrolling:touch; /* плавный скролл на iOS */
    }
    .wrap{
      padding:16px;
      display:flex;flex-direction:column;gap:14px;
      align-items:center;
      max-width:520px;margin:0 auto;
    }
    video.view{width:100%;max-width:480px;border-radius:16px;background:#000}
    canvas#c{display:none}
    .title{font-size:16px;opacity:.95;text-align:center}
    .pill{font-variant-numeric:tabular-nums;font-weight:700;background:#0f1620;border:1px solid #1d2732;border-radius:999px;padding:8px 12px}
    .status{font-size:14px;opacity:.85;text-align:center}
    .err{color:#ff6b6b}
    .muted{opacity:.8}
    .btn{appearance:none;border:1px solid #1d2732;background:#0f1620;color:#fff;border-radius:10px;padding:10px 14px;font-size:14px}
    .btn:active{transform:scale(0.99)}
    #closeBtn{display:none;margin-top:8px}
    #closeBtn.show{display:inline-block}

    /* якорная невидимая камера (поток живёт весь сеанс) */
    #camHost{position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;pointer-events:none;z-index:-1}

    /* панель плана */
    #planCard{border:1px solid #1d2732;background:#0f1620;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
    #planCard h3{margin:0;font-size:15px;opacity:.95}
    #planText{white-space:pre-wrap;line-height:1.35;opacity:.95}
    #planMedia{width:100%;aspect-ratio:16/9;border-radius:10px;overflow:hidden}
    #plan a{color:#9ecbff;text-decoration:none}
    #plan a:hover{text-decoration:underline}
  </style>
</head>
<body>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- общий video с потоком, чтобы он не отваливался -->
<div id="camHost"><video id="cam" playsinline muted></video></div>

<div class="wrap">
  <div class="title">Камера готовится…</div>

  <!-- План тренировки (если переданы plan_text/plan_video) -->
  <div id="plan" style="width:100%;max-width:480px;display:none;">
    <div id="planCard">
      <h3>План тренировки</h3>
      <div id="planText"></div>
      <div id="planMedia"></div>
    </div>
  </div>

  <video id="v" class="view" playsinline autoplay muted></video>
  <canvas id="c"></canvas>

  <div class="pill">Снимки выполняются: 1 — случайно, 2 и 3 — через отдых</div>
  <div class="status muted">Не закрывай это окно до конца тренировки.</div>

  <button id="closeBtn" class="btn">Закрыть</button>
</div>

<script>
(() => {
  const tg = window.Telegram?.WebApp;
  tg?.expand?.(); tg?.ready?.();

  // ====== СИНГЛТОН КАМЕРЫ ======
  const camEl = document.getElementById('cam');
  async function getSharedStream() {
    if (window.__sharedStream && window.__sharedStream.getVideoTracks().some(t => t.readyState === 'live')) {
      return window.__sharedStream;
    }
    if (!navigator.mediaDevices?.getUserMedia) {
      throw new Error('Камера недоступна в этом браузере.');
    }
    let s;
    try {
      s = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'user' }, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });
    } catch {
      s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    }
    window.__sharedStream = s;
    camEl.srcObject = s;
    try { await camEl.play(); } catch {}
    return s;
  }
  async function attachVisibleVideo(viewEl) {
    const s = await getSharedStream();
    if (viewEl.srcObject !== s) viewEl.srcObject = s;
    try { await viewEl.play(); } catch {}
  }
  function stopSharedStream() {
    const s = window.__sharedStream;
    if (s) { try { s.getTracks().forEach(t => t.stop()); } catch {} }
    window.__sharedStream = null;
  }

  // ====== Остальной код ======
  let wakeLock = null, keepAliveTimer = null;
  let canClose = false;

  const v = document.getElementById('v');
  const c = document.getElementById('c');
  const title = document.querySelector('.title');
  const pill  = document.querySelector('.pill');
  const status= document.querySelector('.status');
  const closeBtn = document.getElementById('closeBtn');

  const qs = new URLSearchParams(location.search);
  const totalSec  = Math.max(60, parseInt(qs.get('window') || '3600', 10));  // длительность окна
  const restSec   = Math.max(1,  parseInt(qs.get('rest')   || '60',   10));  // отдых между 2 и 3
  const inTelegram = !!(tg && (tg.platform || tg.initDataUnsafe?.user || (tg.initData && tg.initData.length)));
  const dev = qs.get('dev') === '1' || !inTelegram;

  function setStatus(text, isErr=false){
    status.textContent = text;
    status.className = 'status' + (isErr ? ' err' : ' muted');
  }
  const sleep = ms => new Promise(r=>setTimeout(r, ms));

  function canvasToBlob(canvas, type='image/jpeg', q=0.9){
    return new Promise(res=>{
      if (canvas.toBlob) return canvas.toBlob(b=>res(b), type, q);
      const dataURL = canvas.toDataURL(type, q);
      const bin = atob(dataURL.split(',')[1]);
      const bytes = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
      res(new Blob([bytes], {type}));
    });
  }

  async function captureAndUploadToken(){
    const vw = camEl.videoWidth || 720, vh = camEl.videoHeight || 1280;
    const w = Math.min(1280, vw), h = Math.round(w * (vh / vw));
    c.width = w; c.height = h;
    const ctx = c.getContext('2d', { willReadFrequently:true });
    ctx.drawImage(camEl, 0, 0, w, h);

    const blob = await canvasToBlob(c,'image/jpeg',0.9);
    const form = new FormData();
    form.append('photo', blob, `shot_${Date.now()}.jpg`);
    form.append('initData', inTelegram ? (tg.initData || '') : '');

    const uploadUrl = new URL('/upload' + (dev ? '?dev=1' : ''), location.origin).toString();
    const r = await fetch(uploadUrl, { method:'POST', body:form });
    if (!r.ok){
      const t = await r.text().catch(()=>String(r.status));
      throw new Error(`Upload failed: ${r.status} ${t}`);
    }
    const data = await r.json();
    if (!data?.token) throw new Error('No token from server');
    return String(data.token);
  }

  // Wake Lock + keep-alive
  async function requestWakeLock(){
    try{
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
        document.addEventListener('visibilitychange', async () => {
          if (document.visibilityState === 'visible') {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch {}
            attachVisibleVideo(v);
          }
        });
      }
    }catch(e){}
  }
  function startKeepAlive(){
    clearInterval(keepAliveTimer);
    keepAliveTimer = setInterval(() => {
      v.play?.().catch(()=>{});
      camEl.play?.().catch(()=>{});
      tg?.expand?.();
    }, 30000);
  }
  function stopKeepAlive(){ clearInterval(keepAliveTimer); keepAliveTimer=null; }

  function showCloseControls(){
    try{
      tg?.MainButton?.setParams?.({text:'Закрыть', is_visible:true});
      tg?.MainButton?.show?.();
      tg?.onEvent?.('mainButtonClicked', () => { canClose = true; tg?.close?.(); });
    }catch(_){}
    closeBtn.classList.add('show');
    closeBtn.onclick = () => {
      canClose = true;
      window.close();
      setTimeout(() => alert('Можно закрыть вкладку/вернуться назад.'), 100);
    };
  }

  function planShots(totalSec, restSec){
    const totalMs = totalSec*1000, restMs = restSec*1000;
    const minFirst = Math.max(restMs, 5000);
    const latestFirst = Math.max(minFirst, totalMs - 2*restMs - 3000);
    const firstDelay = Math.floor(minFirst + Math.random() * Math.max(1, (latestFirst - minFirst)));
    const t1 = firstDelay;
    const t2 = t1 + restMs;
    const t3 = t2 + restMs;
    return [t1, t2, t3];
  }

  // ====== Рендер плана из параметров URL ======
  const decodePlus = s => (s || '').replace(/\+/g, ' ');
  const planTextParam  = decodePlus(qs.get('plan_text')  || '').trim();
  const planVideoParam = decodePlus(qs.get('plan_video') || '').trim();

  function renderPlan(){
    const planRoot = document.getElementById('plan');
    const planText = document.getElementById('planText');
    const planMedia= document.getElementById('planMedia');
    if (!planRoot) return;

    if (planMedia) planMedia.innerHTML = '';
    if (planText)  planText.textContent = '';

    let hasAnything = false;

    if (planTextParam && planText) {
      planText.textContent = planTextParam;
      planText.style.display = 'block';
      hasAnything = true;
    } else if (planText) {
      planText.style.display = 'none';
    }

    if (planVideoParam && planMedia) {
      const url = planVideoParam;
      const yt = url.match(/^(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/.*?[?&]v=|youtu\.be\/)([\w\-]{6,})/i);
      const vk = url.match(/^(?:https?:\/\/)?(?:www\.)?vk\.com\/video/i);

      if (yt) {
        const vid = yt[1];
        const iframe = document.createElement('iframe');
        iframe.src = `https://www.youtube.com/embed/${vid}`;
        iframe.setAttribute('allowfullscreen', '');
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        planMedia.appendChild(iframe);
        hasAnything = true;
      } else if (vk) {
        const a = document.createElement('a');
        a.href = url; a.textContent = "Открыть видео VK";
        a.target = "_blank"; a.rel = "noopener";
        a.style.display = "inline-block";
        planMedia.style.aspectRatio = "auto";
        planMedia.appendChild(a);
        hasAnything = true;
      } else {
        const ext = url.split('?')[0].split('#')[0].split('.').pop().toLowerCase();
        if (['mp4','webm','ogg','mov','m4v'].includes(ext)) {
          const video = document.createElement('video');
          video.src = url;
          video.controls = true;
          video.playsInline = true;
          video.style.width = "100%";
          video.style.height = "100%";
          planMedia.appendChild(video);
          hasAnything = true;
        } else {
          const a = document.createElement('a');
          a.href = url; a.textContent = "Открыть видео";
          a.target = "_blank"; a.rel = "noopener";
          a.style.display = "inline-block";
          planMedia.style.aspectRatio = "auto";
          planMedia.appendChild(a);
          hasAnything = true;
        }
      }
      planMedia.style.display = 'block';
    } else if (planMedia) {
      planMedia.style.display = 'none';
    }

    planRoot.style.display = hasAnything ? 'block' : 'none';
  }

  async function runWorkout(){
    title.textContent = 'Режим тренировки';
    pill.textContent  = `Окно: ${Math.round(totalSec/60)} мин • отдых: ${restSec} сек`;
    setStatus('Камера активна. Не закрывай это окно.');

    renderPlan();

    await requestWakeLock();
    startKeepAlive();

    // ⚠️ НЕ уходим в fullscreen — иначе на телефоне не будет скролла
    // try { await document.documentElement.requestFullscreen?.(); } catch {}
    // try { await screen.orientation?.lock?.('portrait'); } catch {}

    await attachVisibleVideo(v);

    const start = Date.now();
    const [t1, t2, t3] = planShots(totalSec, restSec);
    const tokens = [];

    await sleep(Math.max(0, t1 - (Date.now() - start)));
    try { tokens.push(await captureAndUploadToken()); setStatus('Снимок 1/3 выполнен…'); }
    catch(e){ setStatus('Ошибка на снимке 1: '+(e?.message||e), true); }

    await sleep(Math.max(0, t2 - (Date.now() - start)));
    try { tokens.push(await captureAndUploadToken()); setStatus('Снимок 2/3 выполнен…'); }
    catch(e){ setStatus('Ошибка на снимке 2: '+(e?.message||e), true); }

    await sleep(Math.max(0, t3 - (Date.now() - start)));
    try { tokens.push(await captureAndUploadToken()); setStatus('Снимок 3/3 выполнен…'); }
    catch(e){ setStatus('Ошибка на снимке 3: '+(e?.message||e), true); }

    const endAt = start + totalSec*1000;
    const remain = endAt - Date.now();
    if (remain > 0) {
      setStatus('Дождись окончания окна тренировки…');
      await sleep(remain);
    }

    try{
      if (inTelegram) {
        tg.sendData(JSON.stringify({ type:'workout_set', tokens }));
      } else {
        console.log('DEV tokens:', tokens);
      }
    }catch(e){ console.error(e); }

    pill.textContent = 'Сеанс завершён';
    setStatus('Готово. Нажми «Закрыть», чтобы выйти.');

    stopSharedStream();
    stopKeepAlive();
    // try { await screen.orientation?.unlock?.(); } catch {}

    showCloseControls();
  }

  async function run(){
    try{
      await runWorkout();
    }catch(e){
      console.error(e);
      setStatus('Ошибка камеры/загрузки: ' + (e?.message||e), true);
      stopSharedStream(); stopKeepAlive();
    }
  }

  // защита от случайного закрытия
  window.addEventListener('beforeunload', (e) => {
    if (!canClose) { e.preventDefault(); e.returnValue = ''; }
  });
  tg?.onEvent?.('viewportChanged', () => tg?.expand?.());
  window.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') attachVisibleVideo(v);
  });

  run();
})();
</script>
</body>
</html>
